# üîå Integra√ß√£o com Chatwoot - Documenta√ß√£o T√©cnica

## üì° Como Funciona a Integra√ß√£o

### **API REST do Chatwoot**

O Chatwoot possui uma API REST completa e bem documentada que permite gerenciar todos os recursos da plataforma.

**Documenta√ß√£o oficial:**
- https://www.chatwoot.com/developers/api/
- Swagger/OpenAPI dispon√≠vel em: `https://sua-instancia.chatwoot.com/api-docs`

---

## üîë Autentica√ß√£o

### **1. Obter API Key**

```
Settings ‚Üí Profile ‚Üí Access Token
```

A API Key d√° acesso completo √† conta. **Mantenha segura!**

### **2. Usar nos Requests**

```python
import requests

headers = {
    'api_access_token': 'SUA_API_KEY_AQUI',
    'Content-Type': 'application/json'
}

response = requests.get(
    'https://app.chatwoot.com/api/v1/accounts/1/conversations',
    headers=headers
)
```

---

## üèóÔ∏è Estrutura da API

### **URL Base**
```
https://{sua-instancia}.chatwoot.com/api/v1/accounts/{account_id}
```

### **Principais Endpoints**

| Recurso | Endpoint | M√©todos |
|---------|----------|---------|
| **Conversas** | `/conversations` | GET, POST, PUT, DELETE |
| **Mensagens** | `/conversations/{id}/messages` | GET, POST |
| **Contatos** | `/contacts` | GET, POST, PUT, DELETE |
| **Agentes** | `/agents` | GET, POST, PUT, DELETE |
| **Times** | `/teams` | GET, POST, PUT, DELETE |
| **Inboxes** | `/inboxes` | GET, POST, PUT, DELETE |
| **Labels** | `/labels` | GET, POST, PUT, DELETE |
| **Canned Responses** | `/canned_responses` | GET, POST, PUT, DELETE |
| **Webhooks** | `/webhooks` | GET, POST, PUT, DELETE |
| **Automation Rules** | `/automation_rules` | GET, POST, PUT, DELETE |
| **Reports** | `/reports` | GET |

---

## üìä Recursos Dispon√≠veis na API

### ‚úÖ **Implementados no Script B√°sico**
- Conversas
- Contatos
- Mensagens
- Inboxes
- Labels b√°sicas
- Custom Attributes

### ‚ö° **Implementados no Script PRO**
- **Times/Equipes** - Organiza√ß√£o por departamentos
- **Agentes** - Com roles (Admin, Agent, Supervisor)
- **Prioridades** - Low, Medium, High, Urgent
- **Notas Privadas** - Coment√°rios internos da equipe
- **SLA** - Service Level Agreement tracking
- **Canned Responses** - Respostas prontas/templates
- **Automa√ß√µes** - Regras de workflow autom√°tico
- **CSAT** - Customer Satisfaction surveys
- **Atribui√ß√µes** - Auto-assign de conversas
- **Status** - Open, Pending, Resolved, Snoozed
- **Macros** - A√ß√µes em lote

---

## üîß Exemplos de Uso da API

### **1. Criar Contato**
```python
import requests

url = "https://app.chatwoot.com/api/v1/accounts/1/contacts"
headers = {
    "api_access_token": "sua_key",
    "Content-Type": "application/json"
}
data = {
    "name": "Jo√£o Silva",
    "email": "joao@exemplo.com",
    "phone_number": "+5511999999999",
    "custom_attributes": {
        "cidade": "S√£o Paulo",
        "interesse": "Produto X"
    }
}

response = requests.post(url, headers=headers, json=data)
contato = response.json()
print(f"Contato criado: ID {contato['id']}")
```

### **2. Criar Conversa**
```python
url = "https://app.chatwoot.com/api/v1/accounts/1/conversations"
data = {
    "inbox_id": 1,
    "contact_id": 123,
    "status": "open",
    "priority": "high"
}

response = requests.post(url, headers=headers, json=data)
conversa = response.json()
```

### **3. Enviar Mensagem**
```python
conversation_id = 456
url = f"https://app.chatwoot.com/api/v1/accounts/1/conversations/{conversation_id}/messages"

data = {
    "content": "Ol√°! Como posso ajudar?",
    "message_type": "outgoing",  # ou "incoming"
    "private": False  # True para notas privadas
}

response = requests.post(url, headers=headers, json=data)
```

### **4. Adicionar Label**
```python
conversation_id = 456
url = f"https://app.chatwoot.com/api/v1/accounts/1/conversations/{conversation_id}/labels"

data = {
    "labels": ["urgente", "vip", "follow-up"]
}

response = requests.post(url, headers=headers, json=data)
```

### **5. Criar Time**
```python
url = "https://app.chatwoot.com/api/v1/accounts/1/teams"
data = {
    "name": "Vendas",
    "description": "Equipe de vendas e relacionamento",
    "allow_auto_assign": True
}

response = requests.post(url, headers=headers, json=data)
time = response.json()
```

### **6. Adicionar Agente**
```python
url = "https://app.chatwoot.com/api/v1/accounts/1/agents"
data = {
    "name": "Maria Santos",
    "email": "maria@empresa.com",
    "role": "agent"  # admin, agent, ou supervisor
}

response = requests.post(url, headers=headers, json=data)
```

### **7. Criar Resposta Pronta**
```python
url = "https://app.chatwoot.com/api/v1/accounts/1/canned_responses"
data = {
    "short_code": "ola",
    "content": "Ol√°! Seja bem-vindo ao nosso atendimento. Como posso ajudar?"
}

response = requests.post(url, headers=headers, json=data)
```

### **8. Criar Automa√ß√£o**
```python
url = "https://app.chatwoot.com/api/v1/accounts/1/automation_rules"
data = {
    "name": "Atribuir conversa nova",
    "description": "Auto-assign novas conversas ao time de vendas",
    "event_name": "conversation_created",
    "conditions": [
        {
            "attribute_key": "status",
            "filter_operator": "equal_to",
            "values": ["open"]
        }
    ],
    "actions": [
        {
            "action_name": "assign_team",
            "action_params": [1]  # ID do time
        }
    ]
}

response = requests.post(url, headers=headers, json=data)
```

### **9. Enviar CSAT**
```python
conversation_id = 456
url = f"https://app.chatwoot.com/api/v1/accounts/1/conversations/{conversation_id}/messages"

data = {
    "content": "Como voc√™ avalia nosso atendimento?",
    "message_type": "outgoing",
    "content_attributes": {
        "submitted_values": [
            {"name": "csat_survey_response", "value": ""}
        ]
    }
}

response = requests.post(url, headers=headers, json=data)
```

---

## üîí Seguran√ßa e Rate Limits

### **Rate Limiting**
- **100 requisi√ß√µes por minuto** por API key
- Status code `429` quando exceder
- Header `X-RateLimit-Remaining` indica requisi√ß√µes restantes

### **Boas Pr√°ticas**
```python
import time
import requests

def fazer_request_com_retry(url, headers, data, max_retries=3):
    """Faz request com retry autom√°tico em caso de rate limit"""
    for tentativa in range(max_retries):
        response = requests.post(url, headers=headers, json=data)
        
        if response.status_code == 429:
            # Rate limit atingido, aguardar
            time.sleep(2 ** tentativa)  # Exponential backoff
            continue
        
        return response
    
    raise Exception("Rate limit excedido ap√≥s m√∫ltiplas tentativas")
```

---

## üìù Estrutura de Dados

### **Conversa (Conversation)**
```json
{
  "id": 123,
  "inbox_id": 1,
  "contact_id": 456,
  "status": "open",
  "priority": "medium",
  "assignee_id": 789,
  "team_id": 10,
  "labels": ["vip", "urgente"],
  "custom_attributes": {
    "valor_pedido": "R$ 1.500,00",
    "produto": "Plano Premium"
  },
  "sla_policy_id": 1,
  "created_at": "2024-01-19T10:00:00Z",
  "updated_at": "2024-01-19T15:30:00Z"
}
```

### **Contato (Contact)**
```json
{
  "id": 456,
  "name": "Jo√£o Silva",
  "email": "joao@exemplo.com",
  "phone_number": "+5511999999999",
  "custom_attributes": {
    "cidade": "S√£o Paulo",
    "interesse": "Produto X",
    "score": "hot"
  },
  "created_at": "2024-01-15T08:00:00Z"
}
```

### **Mensagem (Message)**
```json
{
  "id": 789,
  "content": "Ol√°! Como posso ajudar?",
  "message_type": "outgoing",
  "private": false,
  "sender_id": 123,
  "conversation_id": 456,
  "attachments": [],
  "created_at": "2024-01-19T10:05:00Z"
}
```

---

## üéØ Limita√ß√µes e Considera√ß√µes

### **O que a API PODE fazer:**
‚úÖ Criar/editar/deletar todos os recursos
‚úÖ Buscar e filtrar dados
‚úÖ Configurar automa√ß√µes
‚úÖ Gerenciar times e agentes
‚úÖ Enviar mensagens e arquivos
‚úÖ Aplicar labels e atributos
‚úÖ Gerar relat√≥rios

### **O que a API N√ÉO PODE fazer:**
‚ùå Enviar mensagens via WhatsApp oficial (precisa de integra√ß√£o espec√≠fica)
‚ùå Acessar recursos de outras contas
‚ùå Modificar configura√ß√µes de billing
‚ùå Criar super admins via API

---

## üîÑ Webhooks

O Chatwoot pode enviar webhooks para seu servidor quando eventos ocorrem:

```python
# Criar webhook
url = "https://app.chatwoot.com/api/v1/accounts/1/webhooks"
data = {
    "url": "https://seu-servidor.com/webhook",
    "subscriptions": [
        "conversation_created",
        "message_created",
        "conversation_resolved"
    ]
}

response = requests.post(url, headers=headers, json=data)
```

**Eventos dispon√≠veis:**
- `conversation_created`
- `conversation_updated`
- `conversation_resolved`
- `message_created`
- `message_updated`
- `contact_created`
- `contact_updated`

---

## üìö Recursos Adicionais

- **Documenta√ß√£o oficial:** https://www.chatwoot.com/developers/api/
- **Exemplos em v√°rias linguagens:** https://github.com/chatwoot/chatwoot/tree/develop/docs/api
- **Postman Collection:** Dispon√≠vel na documenta√ß√£o oficial
- **SDK n√£o-oficial Python:** `pip install chatwoot-python` (comunidade)

---

## üí° Dicas Pro

### **Batch Processing**
Para criar muitos dados, use threading:

```python
from concurrent.futures import ThreadPoolExecutor

def criar_contato(dados):
    return requests.post(url, headers=headers, json=dados)

contatos_para_criar = [...]

with ThreadPoolExecutor(max_workers=5) as executor:
    resultados = executor.map(criar_contato, contatos_para_criar)
```

### **Caching**
Armazene IDs de recursos criados para reusar:

```python
cache = {
    'agentes': {},
    'times': {},
    'inboxes': {}
}

# Criar apenas se n√£o existir
if 'vendas' not in cache['times']:
    time = criar_time('Vendas')
    cache['times']['vendas'] = time['id']
```

---

**Desenvolvido para WhatPro Chat**
