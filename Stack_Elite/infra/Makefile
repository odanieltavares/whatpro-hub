# ==========================================
# ELITE SDR STACK â€” Makefile de OrquestraÃ§Ã£o
# ==========================================
# Uso:
#   make up        â†’ Sobe tudo (nÃºcleo + motor IA + MCPs)
#   make down      â†’ Para tudo
#   make core      â†’ Sobe sÃ³ a infraestrutura base
#   make ai        â†’ Sobe sÃ³ os modelos OSS de IA
#   make mcp       â†’ Sobe sÃ³ os MCP servers internos
#   make logs      â†’ Exibe logs de todos os serviÃ§os
#   make status    â†’ Checa o status dos containers

COMPOSE_CORE    = docker-compose -f docker-compose.core.yml
COMPOSE_AI      = docker-compose -f docker-compose.ai-engine.yml
COMPOSE_MCP     = docker-compose -f docker-compose.mcp.yml

.PHONY: up down core ai mcp logs status restart rebuild

## Sobe tudo em sequÃªncia (espera healthcheck do postgres)
up: core ai mcp

## Sobe apenas o nÃºcleo (n8n, postgres, redis, langfuse, metabase)
core:
	@echo "ðŸŸ¢ Subindo nÃºcleo de infraestrutura..."
	$(COMPOSE_CORE) up -d
	$(COMPOSE_CORE) ps

## Sobe apenas o motor de IA OSS (whisper, llava, gliner, security, rag, sentiment)
ai:
	@echo "ðŸ§  Subindo motor de IA OSS..."
	$(COMPOSE_AI) up -d
	$(COMPOSE_AI) ps

## Sobe apenas os MCP servers internos
mcp:
	@echo "ðŸ”Œ Subindo MCP Servers internos..."
	$(COMPOSE_MCP) up -d
	$(COMPOSE_MCP) ps

## Para e remove todos os containers
down:
	@echo "ðŸ”´ Parando todos os serviÃ§os..."
	$(COMPOSE_MCP) down
	$(COMPOSE_AI) down
	$(COMPOSE_CORE) down

## Reinicia tudo
restart: down up

## Rebuild completo (Ãºtil apÃ³s mudanÃ§as de cÃ³digo)
rebuild:
	@echo "ðŸ”¨ Rebuilding imagens..."
	$(COMPOSE_CORE) build
	$(COMPOSE_AI) build
	$(COMPOSE_MCP) build
	@echo "âœ… Build concluÃ­do. Execute 'make up' para iniciar."

## Logs de todos os serviÃ§os
logs:
	@echo "--- CORE LOGS ---"
	$(COMPOSE_CORE) logs --tail=20
	@echo "--- AI ENGINE LOGS ---"
	$(COMPOSE_AI) logs --tail=20
	@echo "--- MCP LOGS ---"
	$(COMPOSE_MCP) logs --tail=20

## Status de todos os containers
status:
	@echo "=== CORE ==="
	$(COMPOSE_CORE) ps
	@echo "=== AI ENGINE ==="
	$(COMPOSE_AI) ps
	@echo "=== MCP SERVERS ==="
	$(COMPOSE_MCP) ps
