-- ============================================================================
-- WhatPro Hub - Database Initialization Script
-- ============================================================================
-- This script runs on first PostgreSQL startup to create all required databases
-- ============================================================================

-- Create Chatwoot database
CREATE DATABASE chatwoot;

-- Create WhatPro Hub database (already default, but ensure it exists)
-- CREATE DATABASE whatpro_hub; -- Already created via POSTGRES_DB env var

-- Enable pgvector extension on WhatPro Hub database
\c whatpro_hub;
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Enable pgvector on Chatwoot database (optional, for future AI features)
\c chatwoot;
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Back to default database
\c whatpro_hub;

-- ============================================================================
-- WhatPro Hub Schema - Core Tables
-- ============================================================================

-- Accounts (synced from Chatwoot)
CREATE TABLE IF NOT EXISTS accounts (
    id SERIAL PRIMARY KEY,
    chatwoot_id INTEGER UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    locale VARCHAR(10) DEFAULT 'pt_BR',
    domain VARCHAR(255),
    support_email VARCHAR(255),
    status VARCHAR(20) DEFAULT 'active',
    features JSONB DEFAULT '{}',
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Users (synced from Chatwoot)
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    chatwoot_id INTEGER UNIQUE NOT NULL,
    account_id INTEGER REFERENCES accounts(id) ON DELETE CASCADE,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255),
    avatar_url TEXT,
    chatwoot_role VARCHAR(50) DEFAULT 'agent',  -- admin, agent
    whatpro_role VARCHAR(50) DEFAULT 'agent',   -- super_admin, admin, supervisor, agent
    custom_role_id INTEGER,
    availability_status VARCHAR(20) DEFAULT 'online',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Teams (synced from Chatwoot)
CREATE TABLE IF NOT EXISTS teams (
    id SERIAL PRIMARY KEY,
    chatwoot_id INTEGER UNIQUE NOT NULL,
    account_id INTEGER REFERENCES accounts(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    allow_auto_assign BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Team Members
CREATE TABLE IF NOT EXISTS team_members (
    id SERIAL PRIMARY KEY,
    team_id INTEGER REFERENCES teams(id) ON DELETE CASCADE,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(team_id, user_id)
);

-- Providers (WhatsApp API providers)
CREATE TABLE IF NOT EXISTS providers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    account_id INTEGER REFERENCES accounts(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50) NOT NULL,  -- evolution, uazapi, baileys
    base_url TEXT NOT NULL,
    api_key_encrypted TEXT NOT NULL,
    instance_name VARCHAR(255),
    status VARCHAR(20) DEFAULT 'disconnected',
    health_check_url TEXT,
    last_health_check TIMESTAMP WITH TIME ZONE,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Sessions (JWT sessions)
CREATE TABLE IF NOT EXISTS sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) UNIQUE NOT NULL,
    ip_address INET,
    user_agent TEXT,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Audit Logs
CREATE TABLE IF NOT EXISTS audit_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
    account_id INTEGER REFERENCES accounts(id) ON DELETE CASCADE,
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(100) NOT NULL,
    resource_id VARCHAR(255),
    old_values JSONB,
    new_values JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================================================
-- Kanban Tables
-- ============================================================================

-- Boards
CREATE TABLE IF NOT EXISTS boards (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    account_id INTEGER REFERENCES accounts(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    type VARCHAR(50) DEFAULT 'pipeline',  -- pipeline, support, custom
    is_default BOOLEAN DEFAULT false,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Stages (Kanban columns)
CREATE TABLE IF NOT EXISTS stages (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    board_id UUID REFERENCES boards(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    color VARCHAR(7) DEFAULT '#4ECDC4',
    position INTEGER NOT NULL,
    sla_hours INTEGER,
    auto_actions JSONB DEFAULT '[]',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Cards (linked to Chatwoot conversations)
CREATE TABLE IF NOT EXISTS cards (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    stage_id UUID REFERENCES stages(id) ON DELETE CASCADE,
    chatwoot_conversation_id INTEGER NOT NULL,
    chatwoot_contact_id INTEGER,
    title VARCHAR(255),
    contact_name VARCHAR(255),
    contact_avatar_url TEXT,
    last_message TEXT,
    last_message_at TIMESTAMP WITH TIME ZONE,
    value DECIMAL(15, 2),
    priority VARCHAR(20) DEFAULT 'medium',  -- low, medium, high, urgent
    due_date TIMESTAMP WITH TIME ZONE,
    assignee_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
    labels TEXT[] DEFAULT '{}',
    custom_attributes JSONB DEFAULT '{}',
    position INTEGER NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(stage_id, chatwoot_conversation_id)
);

-- Card History (movements)
CREATE TABLE IF NOT EXISTS card_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    card_id UUID REFERENCES cards(id) ON DELETE CASCADE,
    user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
    action VARCHAR(50) NOT NULL,  -- created, moved, updated, archived
    from_stage_id UUID,
    to_stage_id UUID,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================================================
-- Indexes for Performance
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_accounts_chatwoot_id ON accounts(chatwoot_id);
CREATE INDEX IF NOT EXISTS idx_users_chatwoot_id ON users(chatwoot_id);
CREATE INDEX IF NOT EXISTS idx_users_account_id ON users(account_id);
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_teams_account_id ON teams(account_id);
CREATE INDEX IF NOT EXISTS idx_providers_account_id ON providers(account_id);
CREATE INDEX IF NOT EXISTS idx_sessions_user_id ON sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_sessions_expires_at ON sessions(expires_at);
CREATE INDEX IF NOT EXISTS idx_audit_logs_account_id ON audit_logs(account_id);
CREATE INDEX IF NOT EXISTS idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX IF NOT EXISTS idx_boards_account_id ON boards(account_id);
CREATE INDEX IF NOT EXISTS idx_stages_board_id ON stages(board_id);
CREATE INDEX IF NOT EXISTS idx_cards_stage_id ON cards(stage_id);
CREATE INDEX IF NOT EXISTS idx_cards_conversation_id ON cards(chatwoot_conversation_id);
CREATE INDEX IF NOT EXISTS idx_cards_assignee_id ON cards(assignee_id);
CREATE INDEX IF NOT EXISTS idx_card_history_card_id ON card_history(card_id);

-- ============================================================================
-- Grant permissions
-- ============================================================================

GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO postgres;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO postgres;

-- Done!
SELECT 'WhatPro Hub database initialized successfully!' AS status;
